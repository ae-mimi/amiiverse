---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import PlatformLinks from "../../components/PlatformLinks.astro";

export async function getStaticPaths() {
    const releases = await getCollection("releases");
    return releases.map((release) => ({
        params: { slug: release.slug },
        props: { release },
    }));
}

const { release } = Astro.props;
const { Content } = await release.render();

const platforms = [
    { name: "Spotify", url: release.data.spotify, icon: "spotify" },
    { name: "Apple Music", url: release.data.apple, icon: "apple" },
    { name: "YouTube", url: release.data.youtube, icon: "youtube" },
    { name: "SoundCloud", url: release.data.soundcloud, icon: "soundcloud" },
    { name: "Audiomack", url: release.data.audiomack, icon: "audiomack" },
    { name: "Boomplay", url: release.data.boomplay, icon: "boomplay" },
    { name: "Deezer", url: release.data.deezer, icon: "deezer" },
    { name: "Tidal", url: release.data.tidal, icon: "tidal" },
    { name: "Amazon", url: release.data.amazon, icon: "amazon" },
].filter((p) => p.url); // Only show platforms with URLs

// Determine primary embed (Simplified logic)
const embedUrl = release.data.spotify
    ? `https://open.spotify.com/embed/track/${release.data.spotify.split("/").pop()}?utm_source=generator&theme=0`
    : release.data.youtube
      ? `https://www.youtube.com/embed/${release.data.youtube.split("v=")[1]}`
      : null;
---

<BaseLayout title={`${release.data.title} | amii`}>
    <article class="section container" style="max-width: 1000px;">
        <div class="grid cols-2-layout">
            <div class="col-visual">
                <img
                    src={release.data.cover}
                    alt={`${release.data.title} Cover Art`}
                    style="width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);"
                />
            </div>

            <div class="col-content">
                <h1
                    class="font-heading"
                    style="font-size: 3rem; margin-bottom: 0.5rem; line-height: 1.1;"
                >
                    {release.data.title}
                </h1>
                <p
                    class="opacity-60"
                    style="font-size: 1rem; margin-bottom: 2rem;"
                >
                    {
                        release.data.date.toLocaleDateString(undefined, {
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                        })
                    }
                </p>

                {
                    embedUrl && (
                        <div style="margin-bottom: 2rem;">
                            <iframe
                                style="border-radius:12px; border:none;"
                                src={embedUrl}
                                width="100%"
                                height="152"
                                allowfullscreen=""
                                allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                                loading="lazy"
                            />
                        </div>
                    )
                }

                <PlatformLinks links={platforms} />

                <div class="prose font-body">
                    <Content />
                </div>

                {
                    release.data.credits && (
                        <div style="margin-top: 3rem; border-top: 1px solid var(--color-border); padding-top: 1rem;">
                            <h3
                                class="font-heading"
                                style="font-size: 1.2rem; margin-bottom: 0.5rem;"
                            >
                                Credits
                            </h3>
                            <p
                                class="opacity-80"
                                style="white-space: pre-wrap;"
                            >
                                {release.data.credits}
                            </p>
                        </div>
                    )
                }
            </div>
        </div>
    </article>

    <style>
        .grid.cols-2-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 3rem;
        }
        @media (min-width: 768px) {
            .grid.cols-2-layout {
                grid-template-columns: 400px 1fr;
            }
        }
        .prose p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--color-text);
            color: var(--color-text);
        }
        .btn-outline:hover {
            background: var(--color-text);
            color: var(--color-bg);
        }
    </style>
</BaseLayout>
