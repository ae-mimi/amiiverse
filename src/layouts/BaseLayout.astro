---
import "../styles/global.css";
import Navigation from "../components/Navigation.astro";
import settings from "../data/settings.json";

interface Props {
    title: string;
    description?: string;
    era?: string;
    image?: string;
}

const {
    title,
    description = settings.siteDescription || "amii - Official Website",
    era = settings.activeEra || "base",
    image = settings.metaImage || "/placeholder-hero.jpg",
} = Astro.props;

const finalTitle = title || settings.siteTitle || "amii";
const favicon = settings.favicon || "/favicon.svg";
---

<!doctype html>
<html lang="en" data-era={era}>
    <head>
        <meta charset="UTF-8" />
        <meta name="description" content={description} />
        <meta name="viewport" content="width=device-width" />
        <link rel="icon" type="image/x-icon" href={favicon} />
        <meta name="generator" content={Astro.generator} />
        <title>{finalTitle}</title>

        {
            settings.keywords && settings.keywords.length > 0 && (
                <meta name="keywords" content={settings.keywords.join(", ")} />
            )
        }

        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content={Astro.url} />
        <meta property="og:title" content={finalTitle} />
        <meta property="og:description" content={description} />
        <meta property="og:image" content={new URL(image, Astro.url)} />

        <!-- Twitter -->
        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content={Astro.url} />
        <meta property="twitter:title" content={finalTitle} />
        <meta property="twitter:description" content={description} />
        <meta property="twitter:image" content={new URL(image, Astro.url)} />

        <!-- Netlify Identity Widget -->
        <script
            is:inline
            src="https://identity.netlify.com/v1/netlify-identity-widget.js"
        ></script>

        <!-- Analytics Abstraction -->
        <script is:inline>
            window.amiiAnalytics = {
                track: (category, action, label) => {
                    console.log(`[Analytics] ${category} - ${action}`, label);
                    // Placeholder for future GA implementation
                    // if (window.gtag) window.gtag('event', action, { event_category: category, event_label: label });
                },
            };

            // Auto-track elements with data-track attributes
            document.addEventListener("DOMContentLoaded", () => {
                document
                    .querySelectorAll("[data-track-category]")
                    .forEach((el) => {
                        el.addEventListener("click", () => {
                            const category = el.getAttribute(
                                "data-track-category",
                            );
                            const action =
                                el.getAttribute("data-track-action") || "click";
                            const label =
                                el.getAttribute("data-track-label") ||
                                el.href ||
                                el.textContent;
                            window.amiiAnalytics.track(category, action, label);
                        });
                    });
            });
        </script>
    </head>
    <body class="site-body">
        <Navigation activeEra={era} />
        <main class="main-content container">
            <slot />
        </main>
        <footer class="footer">
            <div class="container">
                &copy; {new Date().getFullYear()} amii. All rights reserved.
            </div>
        </footer>

        <script>
            if (window.netlifyIdentity) {
                window.netlifyIdentity.on("init", (user: any) => {
                    if (!user) {
                        window.netlifyIdentity.on("login", () => {
                            document.location.href = "/admin/";
                        });
                    }
                });
            }
        </script>
    </body>
</html>
